---
title: "Final Project"
author: "Jenny Boynton"
date: "5/4/2021"
output: html_document
---



## Plot 1

- I was not super familiar with my meat consumption dataset so I began by creating a few plots just to look at my data from only this dataset. The first plot looked at meat in pounds over time separated by type of meat and divided into separate graphs by country.

```{r, echo = FALSE, warning = FALSE, include = FALSE}
install.packages('plyr', repos = "http://cran.us.r-project.org")
library(tidyverse)
library(lubridate)
install.packages("gapminder", repos = "http://cran.us.r-project.org")
library("gapminder")
library(moderndive)
library(dplyr)
install.packages("skimr", repos = "http://cran.us.r-project.org")
library(skimr)

#load data:

meat_consumption <- read_csv('DP_LIVE_23042021010752391.csv')

gapminder <- gapminder
#change country codes

meat_consumption_countrycode <- meat_consumption %>% 
  mutate(country = recode(LOCATION,
                          AUS = "Australia",
                          CAN = "Canada",
                          JPN = "Japan",
                          KOR = "Korea",
                          MEX = "Mexico",
                          NZL = "New Zealand",
                          TUR = "Turkey",
                          USA = "United States",
                          ARG = "Argentina",
                          BRA = "Brazil",
                          CHL = "Chile",
                          CHN = "China",
                          COL = "Colombia",
                          EGY = "Egypt",
                          ETH = "Ethiopia",
                          IND = "India",
                          IDN = "Indonesia",
                          IRN = "Iran",
                          ISR = "Israel",
                          KAZ = "Kazakhstan",
                          MYS = "Malayasia",
                          NGA = "Nigeria",
                          PAK = "Pakistan",
                          PRY = "Paraguay",
                          PER = "Peru",
                          PHL = "Philippines",
                          RUS = "Russia",
                          SAU = "Saudia Arabia",
                          ZAF = "South Africa",
                          THA = "Thailand",
                          UKR = "Ukraine",
                          VNM = "Vietnam",
                          NOR = "Norway",
                          CHE = "Switzerland",
                          GBR = "United Kingdom",
                          WLD = "NA",
                          OECD = "NA",
                          BRICS = "NA"))
new_meat_consumption <- select(meat_consumption_countrycode, INDICATOR, SUBJECT, MEASURE, TIME, Value, country)

#tidy data and separate by measurement type
Meat_KG <- new_meat_consumption %>% 
  filter(!is.na(Value)) %>%
  filter(MEASURE == "KG_CAP")

Meat_TONNE <- new_meat_consumption %>% 
  filter(!is.na(Value)) %>% 
  filter(MEASURE == "THND_TONNE")

#remove NA that didn't work first time

Meat_KG <- Meat_KG %>% filter(!grepl('NA', country))

Meat_TONNE <- Meat_TONNE %>% filter(!grepl('NA', country))

#more cleaning 
#round decimals to 2 decimal places
Meat_KG <- Meat_KG %>%
  mutate(value = round(Value,2),
         Value = NULL)

#Remember that the OECD's report included forecasted numbers all the way until 2026
Meat_KG <- Meat_KG %>%
  filter(TIME < 2022)

#convert kg into lbs capita
Meat_LB <- Meat_KG %>%
  mutate(value_lb = round(value*2.20462,2),
         value = NULL)

#look at raw data
glimpse(Meat_LB)

```

```{r, include = TRUE, echo = FALSE, fig.width=10,fig.height=11}
# plot w x-axis as year, y-axis as value, color as type of meat & separated by country

ggplot(Meat_LB, aes(TIME, value_lb, color = SUBJECT)) + geom_point()+ geom_line(size=2)+ facet_wrap(~country)+
  theme_classic()+ theme(text = element_text(size=11),
        axis.text.x = element_text(angle=90, hjust=1))+
  labs(x = "Year" , y = "Per Capita Consumption in Pounds", color = "Type of Meat", title='Meat Consumption')
```

## Plot set 2

- Then I wanted a closer look at some of the countries that stood out to me, so I created a few separate graphs for the United States, Argentina, Israel, New Zealand and Paraguay.

```{r, include = TRUE, echo = FALSE, fig.width=10,fig.height=8}
Meat_LB %>%
  filter(country == 'United States')%>%
  ggplot(aes(TIME, value_lb, color=SUBJECT, group=SUBJECT))+
  geom_line(size=2)+
  labs(y='Per Capita Consumption in Pounds', x='Year', color = "Type of Meat", title='Meat Consumption in the United States')+
  theme_classic()

Meat_LB %>%
  filter(country == 'Argentina')%>%
  ggplot(aes(TIME, value_lb, color=SUBJECT, group=SUBJECT))+
  geom_line(size=2)+
  labs(y='Per Capita Consumption in Pounds', x='Year', color = "Type of Meat", title='Meat Consumption in Argentina')+
  theme_classic()

Meat_LB %>%
  filter(country == 'Israel')%>%
  ggplot(aes(TIME, value_lb, color=SUBJECT, group=SUBJECT))+
  geom_line(size=2)+
  labs(y='Per Capita Consumption in Pounds', x='Year', color = "Type of Meat", title='Meat Consumption in Israel')+
  theme_classic()

Meat_LB %>%
  filter(country == 'New Zealand')%>%
  ggplot(aes(TIME, value_lb, color=SUBJECT, group=SUBJECT))+
  geom_line(size=2)+
  labs(y='Per Capita Consumption in Pounds', x='Year', color = "Type of Meat", title='Meat Consumption in New Zealand')+
  theme_classic()

Meat_LB %>%
  filter(country == 'Paraguay')%>%
  ggplot(aes(TIME, value_lb, color=SUBJECT, group=SUBJECT))+
  geom_line(size=2)+
  labs(y='Per Capita Consumption in Pounds', x='Year', color = "Type of Meat", title='Meat Consumption in Paraguay')+
  theme_classic()
```

## Plot 3

- Lastly, still working with only the meat consumption data, I totaled type of meat into one sum and looked at a graph comparing total consumption of meat over time and separated by country.

```{r, echo = FALSE, warning = FALSE, include = FALSE}
#plot with meat totaled

Meat_LB_time <- Meat_LB %>%
  spread(TIME,value_lb)

#take care of those NAs
Meat_LB_time[is.na(Meat_LB_time)] <- 0 

#reformat
Meat_LB_subject <- Meat_LB %>%
  spread(SUBJECT,value_lb)

#Set NAs = 0
Meat_LB_subject[is.na(Meat_LB_subject)] <- 0 


```

```{r, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10,fig.height=10}
Meat_LB_subject %>% group_by(country, TIME)%>%
  summarize(total_meat = sum(c(BEEF, POULTRY, SHEEP, PIG)))%>%
  ggplot(aes(TIME, total_meat, color= country))+ geom_point()+ geom_line(size=2)+
  labs(y='Per Capita Consumption in Pounds', x='Year', color = "Country", title='Total Meat Consumption by Country')+
  theme_classic()+
  theme(text = element_text(size=11),
        axis.text.x = element_text(angle=90, hjust=1))
  #facet_wrap(~country) + theme(legend.position="none")
```

## Plot 4

- Next I combined my two datasets into one dataset to compare meat consumption with life expectancy 

```{r, echo = FALSE, warning = FALSE, include = FALSE}
#combine data

combined_data <- left_join(Meat_LB, gapminder)

#whoops lets rename TIME and year so they combine too

gapminder2.0 <- gapminder %>% rename(TIME=year)

#try again

combined_data <- left_join(Meat_LB, gapminder2.0)

#lets filter out those NAs

combined_data <- combined_data %>% filter(!is.na(continent)) %>% filter(!is.na(lifeExp)) %>% filter(!is.na(pop)) %>% filter(!is.na(gdpPercap))


```

```{r, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10,fig.height=10}
#time to graph
ggplot(combined_data, aes(value_lb, lifeExp, color = SUBJECT)) + geom_point()+ geom_line(size=2)+ facet_wrap(~country)+
  theme_classic()+
  labs(x = "Per Capita Consumption in Pounds", y = "Life Expectancy", color = "Type of Meat", title='Meat Consumption vs. Life Expectancy by Country')
```

## Revised Plot 4

- I noticed this plot was visually challenging to observe so I made an adjustment and allowed the scales of each graph to differ in order to more clearly see the linear patterns.

```{r, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10,fig.height=10}
#time to graph
ggplot(combined_data, aes(value_lb, lifeExp, color = SUBJECT)) + geom_point()+ geom_line(size=2)+ facet_wrap(~country, scale="free")+
  theme_classic()+
  labs(x = "Per Capita Consumption in Pounds", y = "Life Expectancy", color = "Type of Meat", title='Meat Consumption vs. Life Expectancy by Country')
```

- After looking at the graphs, I generated a multiple linear regression model to summarize the dataset looking at life expectancy as a function of consumption quantity, country, time and type of meat; the adjusted R-squared tells me that the graph is 97% fitted to the regression line, meaning only 3% of the variability is unexplained. The p-value tells me it is a statistically significant relationship.

```{r, echo = FALSE, message = FALSE, warning = FALSE, results = TRUE}
#model
model_combined_data <- lm(lifeExp ~ value_lb+country+SUBJECT+TIME, data = combined_data)
summary(model_combined_data)
```



```{r, echo = FALSE, message = FALSE, warning = FALSE, results = TRUE}
#model_Meat_vs_GDPperc <- Meat_vs_GDPperc %>% 
 # split(.$percentage) %>% 
  #map(~lm(lifeExp ~ value_lb, data = .)) 

#summary(model_Meat_vs_GDPperc[[1]])
#summary(model_Meat_vs_GDPperc[[2]])
#summary(model_Meat_vs_GDPperc[[3]])
#summary(model_Meat_vs_GDPperc[[4]])


#map(model_Meat_vs_GDPperc, summary) %>% 
 # map_dfr("r.squared")
```

## Plot 5

- Then I revised the same graph and again summed the values for each type of meat into one total and observed the total meat consumption by country vs. life expectancy.

```{r, echo = FALSE, warning = FALSE, include = FALSE}
#graph meat vs life expectancy by total meat instead of separated by meat type

Total_meat_vs_lifeExp <- left_join(Meat_LB_subject, gapminder2.0)
Total_meat_vs_lifeExp <- Total_meat_vs_lifeExp %>% filter(!is.na(continent)) %>% filter(!is.na(lifeExp)) %>% filter(!is.na(pop)) %>% filter(!is.na(gdpPercap))

```

```{r, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10,fig.height=10}

Total_meat_vs_lifeExp %>% group_by(country, lifeExp)%>%
  summarize(total_meat = sum(c(BEEF, POULTRY, SHEEP, PIG)))%>%
  ggplot(aes(total_meat, lifeExp, color=country))+
  geom_line(size = 2)+
  theme_classic()+
  theme(text = element_text(size=11),
        axis.text.x = element_text(angle=90, hjust=1))+
  labs(y = "Life Expectancy" , x = "Per Capita Consumption in Pounds", color = "Country", title='Total Meat Consumption vs. Life Expectancy by Country')
```

- I generated another multiple linear regression model to summarize the dataset looking at life expectancy as a function of total consumption quantity, country, time and type of meat; the adjusted R-squared tells me that the graph is again 97% fitted to the regression line, meaning only 3% of the variability is unexplained. The p-value again tells me it is a statistically significant relationship.

```{r, echo = FALSE, warning = FALSE, include = FALSE}
#sum the meat values across rows
Totalmeat_vs_lifeExp <- Total_meat_vs_lifeExp %>%  mutate(sum = rowSums(.[5:8]))
```


```{r, echo = FALSE, message = FALSE, warning = FALSE, results = TRUE}
#Second model
model_total_meat <- lm(lifeExp ~ sum+country+TIME, data = Totalmeat_vs_lifeExp)
summary(model_total_meat)
```
 

## Plot 6

- Next, I graphed by continent rather than country again looking at the data with types of meat separated.

```{r, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10,fig.height=10}
combined_data %>% ggplot(aes(value_lb, lifeExp, color = SUBJECT))+
  geom_line(size=2)+
  theme_classic()+theme(text = element_text(size=11),
                        axis.text.x = element_text(angle=90, hjust=1))+
  facet_wrap(~continent)+
  labs(y = "Life Expectancy" , x = "Per Capita Consumption in Pounds", color = "Meat Type", title='Total Meat Consumption vs. Life Expectancy by Continent')
```
 
 - Like with plot 4, these graphs are visually challenging so I again adjusted the scales.
 
```{r, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10,fig.height=10}
combined_data %>% ggplot(aes(value_lb, lifeExp, color = SUBJECT))+
  geom_line(size=2)+
  theme_classic()+theme(text = element_text(size=11),
                        axis.text.x = element_text(angle=90, hjust=1))+
  facet_wrap(~continent, scale="free")+
  labs(y = "Life Expectancy" , x = "Per Capita Consumption in Pounds", color = "Meat Type", title='Total Meat Consumption vs. Life Expectancy by Continent')

```

- I generated another multiple linear regression model to summarize the dataset looking at life expectancy as a function of consumption quantity, continent, time and type of meat; the adjusted R-squared tells me that the graph is 65% fitted to the regression line, meaning only 35% of the variability is unexplained. The p-value again tells me it is a statistically significant relationship.
 
```{r, echo = FALSE, message = FALSE, warning = FALSE, results = TRUE}
model_continent_separatemeattypes <- lm(lifeExp ~ value_lb+continent+TIME+SUBJECT, data = combined_data)
summary(model_continent_separatemeattypes)
```
 

## Plot 7

Next, I again summed the meat to total meat but this time still separating by continent.
```{r, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10,fig.height=10}

Totalmeat_vs_lifeExp %>%
  ggplot(aes(sum, lifeExp, color=continent))+
  geom_line(size = 2)+
  theme_classic()+
  theme(text = element_text(size=11),
        axis.text.x = element_text(angle=90, hjust=1))+
  labs(y = "Life Expectancy" , x = "Per Capita Consumption in Pounds", color = "Continent", title='Total Meat Consumption vs. Life Expectancy by Continent')

```

- I generated another multiple linear regression model to summarize the dataset looking at life expectancy as a function of consumption quantity, continent, time and type of meat; the adjusted R-squared tells me that the graph is 75% fitted to the regression line, meaning only 25% of the variability is unexplained. The p-value again tells me it is a statistically significant relationship.

```{r, echo = FALSE, message = FALSE, warning = FALSE, results = TRUE}
#model 4
model_meatsum_continent <- lm(lifeExp ~ sum+continent+TIME, data = Totalmeat_vs_lifeExp)
summary(model_meatsum_continent)
```


## Plot 8

- Next, I played with the data a little more and looked at meat consumption per country compared with GDP per capita. 

```{r, echo = FALSE, warning = FALSE, include = FALSE}
addUnits <- function(n) {
  labels <- ifelse(n < 1000, n,  # less than thousands
                   ifelse(n < 1e6, paste0(round(n/1e3), 'k'),  # in thousands
                          ifelse(n < 1e9, paste0(round(n/1e6), 'M'),  # in millions
                                 ifelse(n < 1e12, paste0(round(n/1e9), 'B'), # in billions
                                        ifelse(n < 1e15, paste0(round(n/1e12), 'T'), # in trillions
                                               'too big!'
                                        )))))
  return(labels)
}

```

```{r, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10,fig.height=10}
#GDP vs meat by type
ggplot(combined_data, aes(gdpPercap, value_lb, color = SUBJECT)) + geom_point()+ geom_line(size=2)+ facet_wrap(~country, scale = "free")+
  theme_classic()+
  labs(x = "GDP Per Capita" , y = "Per Capita Consumption in Pounds", color = "Type of Meat", title = "GDP Per Capita vs. Meat Consumption by Country") + scale_x_continuous(labels = addUnits)
```

- I generated another multiple linear regression model to summarize the dataset looking at life expectancy as a function of consumption quantity, continent, time and type of meat; the adjusted R-squared tells me that the graph is 65% fitted to the regression line, meaning only 35% of the variability is unexplained. The p-value again tells me it is a statistically significant relationship.


```{r, echo = FALSE, message = FALSE, warning = FALSE, results = TRUE}
#model 5
model_meattype_GDP <- lm(lifeExp ~ value_lb+continent+TIME+SUBJECT, data = combined_data)
summary(model_meattype_GDP)
```

## Plot 9

- Next I summed the meat data once again and created another plot.

```{r, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10,fig.height=10}
Total_meat_vs_lifeExp %>% group_by(country, gdpPercap)%>%
  summarize(total_meat = sum(c(BEEF, POULTRY, SHEEP, PIG)))%>%
  ggplot(aes(x = gdpPercap, y = total_meat, color=country))+
  geom_line(size = 2)+
  theme_classic()+
  theme(text = element_text(size=11),
        axis.text.x = element_text(angle=90, hjust=1))+
 # facet_wrap(~country, scale = "free", nrow=5, ncol=10)+ theme(legend.position="none") +
  scale_x_continuous(labels = addUnits)+
  labs(x = "GDP Per Capita" , y = 'Per Capita Consumption in Pounds', color = "Country", title='Total Meat Consumption vs. GDP Per Capita')
```

## Plot 10

- I used this data to divide my data by income percentage; low, low-medium, high-medium, and high. Instead of dividing by country or continent, this time I divided by income percentage to observe the relationship between meat consumption and life expectancy.

```{r, echo = FALSE, warning = FALSE, include = FALSE}
Meat_vs_GDPperc <- mutate(combined_data, percentage = percent_rank(gdpPercap),
                                          percentage = case_when(percentage > 0 & percentage < 0.25 ~ "low",
                                                                 percentage > 0.25 & percentage < 0.50 ~ "low-medium",
                                                                 percentage > 0.50 & percentage < 0.75 ~ "high-medium",
                                                                 percentage == 0.75 | percentage < 1.0 ~ "high")) 

Totalmeat_vs_lifeExp <- Total_meat_vs_lifeExp %>%  mutate(sum = rowSums(.[5:8]))

Totalmeat_vs_GDPperc <- mutate(Totalmeat_vs_lifeExp, percentage = percent_rank(gdpPercap),
                          percentage = case_when(percentage > 0 & percentage < 0.25 ~ "low",
                                                 percentage > 0.25 & percentage < 0.50 ~ "low-medium",
                                                 percentage > 0.50 & percentage < 0.75 ~ "high-medium",
                                                 percentage == 0.75 | percentage < 1.0 ~ "high")) 

#sum the meat values across rows

##lets redo this, we are going to get percentages based on gdp and then graph with those being the facet wrap and color being meat type 

```


```{r, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10,fig.height=10}

ggplot(Meat_vs_GDPperc, aes(value_lb, lifeExp, color = SUBJECT)) + geom_point()+ geom_line(size=2)+ facet_wrap(~percentage)+
  theme_classic()+
  labs(y = "Life Expectancy" , x = 'Per Capita Consumption in Pounds', color = "Type of Meat", title='Meat Consumption vs. Life Expectancy by Income Percentage')


```


- The R-squared values indicated that the closest percentage to fitting the regression line was the low at only approximately 12%, with the other 3 being under 1%. The p-values also indicated that the low percentage was the one with the most statistical significance, although high and high-medium also had p-values indicating statistical significance.


```{r, echo = FALSE, message = FALSE, warning = FALSE, results = TRUE}
model_Meat_vs_GDPperc <- Meat_vs_GDPperc %>% 
  split(.$percentage) %>% 
  map(~lm(lifeExp ~ value_lb, data = .)) 

summary(model_Meat_vs_GDPperc[[1]])
summary(model_Meat_vs_GDPperc[[2]])
summary(model_Meat_vs_GDPperc[[3]])
summary(model_Meat_vs_GDPperc[[4]])


map(model_Meat_vs_GDPperc, summary) %>% 
  map_dfr("r.squared")
```


```{r, echo = FALSE, warning = FALSE, include = FALSE}
Totalmeat_vs_GDPperc <- Totalmeat_vs_GDPperc %>% filter(!is.na(percentage))
```

# Plot 11

```{r, include = TRUE, echo = FALSE, warning = FALSE, message = FALSE, fig.width=10,fig.height=10}

ggplot(Totalmeat_vs_GDPperc, aes(sum, lifeExp, color = percentage)) + geom_point()+ geom_line(size=2)+
  theme_classic()+
  labs(y = "Life Expectancy" , x = 'Per Capita Consumption in Pounds', color = "Income Percentage", title='Meat Consumption vs. Life Expectancy by Income Percentage')


```

- The R-squared values indicated that the closest percentage to fitting the regression line was the low at only approximately 44%. The p-values also again indicated that the low percentage was the one with the most statistical significance, although high and high-medium also had p-values indicating statistical significance.


```{r, echo = FALSE, message = FALSE, warning = FALSE, results = TRUE}

model_Totalmeat_vs_GDPperc <- Totalmeat_vs_GDPperc %>% 
  split(.$percentage) %>% 
  map(~lm(lifeExp ~ sum, data = .)) 

summary(model_Totalmeat_vs_GDPperc[[1]])
summary(model_Totalmeat_vs_GDPperc[[2]])
summary(model_Totalmeat_vs_GDPperc[[3]])
summary(model_Totalmeat_vs_GDPperc[[4]])
                   
map(model_Totalmeat_vs_GDPperc, summary) %>% 
  map_dfr("r.squared")


```

